name: Release Binaries

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  create-release:
    name: Create GitHub release
    runs-on: ubuntu-latest
    outputs:
      is-draft: ${{ steps.release-info.outputs.is_draft }}
    steps:
      - uses: actions/checkout@v4
      - name: Ensure draft release exists
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ github.ref_name }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          if gh release view "$TAG" --repo "$REPO" >/dev/null 2>&1; then
            echo "Release $TAG already exists; leaving as-is."
          else
            gh release create "$TAG" --repo "$REPO" --draft --title "$TAG" --notes ""
          fi
      - name: Capture release state
        id: release-info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ github.ref_name }}
          REPO: ${{ github.repository }}
        run: |
          is_draft=$(gh release view "$TAG" --repo "$REPO" --json isDraft --jq .isDraft)
          echo "is_draft=$is_draft" >> "$GITHUB_OUTPUT"

  linux:
    name: Linux builds
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target:
          - x86_64-unknown-linux-gnu
          - aarch64-unknown-linux-gnu
    needs: create-release
    steps:
      - name: Explain skip if published
        if: needs.create-release.outputs.is-draft != 'true'
        run: echo "Release is already published; skipping uploads."
      - uses: actions/checkout@v4
        if: needs.create-release.outputs.is-draft == 'true'
      - uses: dtolnay/rust-toolchain@stable
        if: needs.create-release.outputs.is-draft == 'true'
        with:
          targets: x86_64-unknown-linux-gnu,aarch64-unknown-linux-gnu
          components: clippy
      - uses: Swatinem/rust-cache@v2
        if: needs.create-release.outputs.is-draft == 'true'
      - uses: taiki-e/install-action@v2
        if: needs.create-release.outputs.is-draft == 'true'
        with:
          tool: cross
      - name: Upload Linux binaries
        if: needs.create-release.outputs.is-draft == 'true'
        uses: taiki-e/upload-rust-binary-action@v1
        with:
          bin: skrills
          target: ${{ matrix.target }}
          build-tool: cross
          tar: unix
          zip: none
          checksum: sha256
          include: LICENSE,README.md,docs/release-artifacts.md
          token: ${{ secrets.GITHUB_TOKEN }}

  macos:
    name: macOS builds
    runs-on: macos-14
    strategy:
      matrix:
        target:
          - aarch64-apple-darwin
          - x86_64-apple-darwin
    needs: create-release
    steps:
      - name: Explain skip if published
        if: needs.create-release.outputs.is-draft != 'true'
        run: echo "Release is already published; skipping uploads."
      - uses: actions/checkout@v4
        if: needs.create-release.outputs.is-draft == 'true'
      - uses: dtolnay/rust-toolchain@stable
        if: needs.create-release.outputs.is-draft == 'true'
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin
      - uses: Swatinem/rust-cache@v2
        if: needs.create-release.outputs.is-draft == 'true'
      - name: Upload macOS binaries
        if: needs.create-release.outputs.is-draft == 'true'
        uses: taiki-e/upload-rust-binary-action@v1
        with:
          bin: skrills
          target: ${{ matrix.target }}
          tar: unix
          zip: none
          checksum: sha256
          include: LICENSE,README.md,docs/release-artifacts.md
          token: ${{ secrets.GITHUB_TOKEN }}

  windows:
    name: Windows builds
    runs-on: windows-latest
    strategy:
      matrix:
        target:
          - x86_64-pc-windows-msvc
          - aarch64-pc-windows-msvc
    needs: create-release
    steps:
      - name: Explain skip if published
        if: needs.create-release.outputs.is-draft != 'true'
        run: echo "Release is already published; skipping uploads."
      - uses: actions/checkout@v4
        if: needs.create-release.outputs.is-draft == 'true'
      - uses: dtolnay/rust-toolchain@stable
        if: needs.create-release.outputs.is-draft == 'true'
        with:
          targets: x86_64-pc-windows-msvc,aarch64-pc-windows-msvc
      - uses: Swatinem/rust-cache@v2
        if: needs.create-release.outputs.is-draft == 'true'
      - name: Upload Windows binaries
        if: needs.create-release.outputs.is-draft == 'true'
        uses: taiki-e/upload-rust-binary-action@v1
        with:
          bin: skrills
          target: ${{ matrix.target }}
          tar: none
          zip: windows
          checksum: sha256
          include: LICENSE,README.md,docs/release-artifacts.md
          token: ${{ secrets.GITHUB_TOKEN }}

  publish-release:
    name: Publish GitHub release
    runs-on: ubuntu-latest
    needs:
      - linux
      - macos
      - windows
    if: needs.create-release.outputs.is-draft == 'true'
    steps:
      - uses: actions/checkout@v4
      - name: Publish draft release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ github.ref_name }}
          REPO: ${{ github.repository }}
        run: gh release edit "$TAG" --repo "$REPO" --draft=false

  publish-crates:
    name: Publish crates.io packages
    runs-on: ubuntu-latest
    needs:
      - create-release
      - publish-release
    if: needs.create-release.outputs.is-draft == 'true'
    env:
      CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Preflight token and package/build (no upload)
        run: |
          set -euo pipefail
          if [ -z "${CARGO_REGISTRY_TOKEN:-}" ]; then
            echo "CARGO_REGISTRY_TOKEN is not set; cannot publish." >&2
            exit 1
          fi

          pkg() {
            crate="$1"
            echo "::group::package $crate"
            cargo package -p "$crate"
            echo "::endgroup::"
          }

          # Package leaf crates; build dependents to avoid registry lookup before deps are published.
          pkg skrills-state
          pkg skrills-discovery

          echo "::group::check skrills-server"
          cargo check -p skrills-server
          echo "::endgroup::"

          echo "::group::check skrills (cli)"
          cargo check -p skrills
          echo "::endgroup::"
      - name: Publish crates in dependency order
        run: |
          set -euo pipefail

          require_token() {
            if [ -z "${CARGO_REGISTRY_TOKEN:-}" ]; then
              echo "CARGO_REGISTRY_TOKEN is not set; cannot publish." >&2
              exit 1
            fi
          }

          crate_version() {
            python - <<'PY' "$1"
              import json, sys, subprocess
              crate = sys.argv[1]
              meta = json.loads(subprocess.check_output(["cargo", "metadata", "--no-deps", "--format-version", "1"]))
              for pkg in meta["packages"]:
                  if pkg["name"] == crate:
                      print(pkg["version"])
                      sys.exit(0)
              print("crate not found: " + crate, file=sys.stderr)
              sys.exit(1)
PY
          }

          already_published() {
            crate="$1"
            version="$2"
            cargo search "$crate" --limit 1 | grep -q "$crate = \"$version\""
          }

          publish_one() {
            crate="$1"
            version="$(crate_version "$crate")"
            if already_published "$crate" "$version"; then
              echo "Skipping $crate v$version (already on crates.io)"
              return
            fi
            echo "Publishing $crate v$version"
            cargo publish -p "$crate" --token "$CARGO_REGISTRY_TOKEN"
            # allow index to update before dependents publish
            sleep 20
          }

          require_token
          publish_one skrills-state
          publish_one skrills-discovery
          publish_one skrills-server
          publish_one skrills
