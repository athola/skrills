name: Security Audit

on:
  push:
    branches: [main, master]
  pull_request:
  schedule:
    - cron: "15 5 * * 1"

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      rust: ${{ steps.set.outputs.rust }}
    steps:
      - uses: actions/checkout@v4
        if: github.event_name != 'schedule'
        with:
          fetch-depth: 0
      - id: filter
        if: github.event_name != 'schedule'
        uses: dorny/paths-filter@v3
        with:
          filters: |
            rust:
              - 'src/**'
              - 'crates/**'
              - 'Cargo.toml'
              - 'Cargo.lock'
              - 'scripts/**'
              - '.github/workflows/audit.yml'
      - id: set
        run: |
          if [ "${{ github.event_name }}" = "schedule" ]; then
            echo "rust=true" >> "$GITHUB_OUTPUT"
          else
            echo "rust=${{ steps.filter.outputs.rust }}" >> "$GITHUB_OUTPUT"
          fi

  cargo-audit:
    name: Cargo audit
    needs: changes
    if: github.event_name == 'schedule' || needs.changes.outputs.rust == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Install cargo-audit
        run: cargo install cargo-audit --locked
      - name: Run cargo audit
        run: cargo audit

  cargo-deny:
    name: Cargo deny
    needs: changes
    if: github.event_name == 'schedule' || needs.changes.outputs.rust == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Install cargo-deny
        run: cargo install cargo-deny --locked
      - name: Run cargo deny (licenses)
        run: cargo deny check licenses
      - name: Run cargo deny (bans)
        run: cargo deny check bans
      - name: Run cargo deny (sources)
        run: cargo deny check sources
