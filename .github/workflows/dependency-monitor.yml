name: Dependency Monitor

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
  push:
    paths:
      - 'Cargo.toml'
      - 'Cargo.lock'
      - 'crates/**/Cargo.toml'

jobs:
  monitor-dependencies:
    runs-on: ubuntu-latest
    name: Monitor Dependency Security

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-

    - name: Install cargo-audit
      run: cargo install cargo-audit --locked

    - name: Run cargo audit
      run: cargo audit --quiet

    - name: Check for problematic dependencies
      run: |
        echo "Checking for problematic dependencies..."

        # Check for paste dependency specifically
        if cargo tree | grep -q "paste v1.0.15"; then
          echo "WARNING: Found unmaintained 'paste 1.0.15' dependency"
          echo "Path: $(cargo tree | grep paste)"
          echo "This is used by rmcp crate - monitor for updates"
        fi

        # Check for rmcp version
        echo "Current rmcp version:"
        cargo tree | grep "rmcp v" | head -1

        # Check for once_cell (should be none in direct dependencies)
        if cargo tree --depth 1 | grep -q "once_cell"; then
          echo "ERROR: Found direct once_cell dependency - should be migrated to std::sync::LazyLock"
          cargo tree --depth 1 | grep once_cell
          exit 1
        else
          echo "OK: No direct once_cell dependencies found"
        fi

    - name: Check for outdated dependencies
      run: |
        echo "Checking for outdated dependencies..."
        cargo install cargo-outdated --locked || true
        if command -v cargo-outdated >/dev/null 2>&1; then
          cargo outdated --root-deps-only
        else
          echo "WARNING: cargo-outdated not available"
        fi

    - name: Generate dependency report
      run: |
        echo "Dependency Report - $(date)"
        echo "=================================="
        echo ""
        echo "Security audit status:"
        cargo audit --quiet || echo "  WARNING: Audit issues found"
        echo ""
        echo "Critical dependencies:"
        cargo tree --depth 1 | grep -E "(rmcp|tokio|serde|axum)"
        echo ""
        echo "Dependencies to monitor:"
        echo "  - paste 1.0.15 (unmaintained, transitive via rmcp)"
        echo "  - rmcp (monitor for paste dependency removal)"
        echo ""
        echo "Migrations completed:"
        echo "  - once_cell -> std::sync::LazyLock"