name: Publish Dry Run

on:
  pull_request:
    paths:
      - "Cargo.toml"
      - "Cargo.lock"
      - "crates/**/Cargo.toml"
      - ".github/workflows/publish-dry-run.yml"
      - ".github/workflows/release.yml"
      - "scripts/publish_crates.sh"

jobs:
  publish-dry-run:
    name: Dry-run cargo publish (all crates)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Verify crate packaging (dry-run)
        run: |
          set -euo pipefail
          scripts/verify_publish_order.sh

          # List files that would be included in the package
          # This validates include/exclude patterns without requiring
          # dependencies to exist on crates.io
          list_pkg() {
            crate="$1"
            echo "::group::cargo package --list -p $crate"
            cargo package -p "$crate" --list --allow-dirty
            echo "::endgroup::"
          }

          # Full package validation (only for crates already on crates.io)
          full_pkg() {
            crate="$1"
            echo "::group::cargo package -p $crate"
            cargo package -p "$crate" --allow-dirty
            echo "::endgroup::"
          }

          # Verify file inclusion for all crates
          echo "=== Verifying package file inclusion ==="
          publish_order="$(scripts/verify_publish_order.sh --print-order)"
          for crate in ${publish_order}; do
            list_pkg "$crate"
          done

          # Full package validation only for crates already on crates.io
          # (their dependencies are resolvable)
          echo "=== Full package validation for published crates ==="
          full_pkg skrills-state
          full_pkg skrills-discovery

          # Verify all crates compile
          echo "=== Verifying compilation ==="
          echo "::group::cargo check --workspace"
          cargo check --workspace
          echo "::endgroup::"

          echo "[OK] All crate packaging checks passed"
