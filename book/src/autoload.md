# Autoloading Skills and Context

## Skill Discovery

Skills are found by searching through a prioritized sequence of directories. If multiple skills share the same name, the skill found in the directory with the highest priority is used.

The default discovery priority follows this order:

1. `~/.codex/skills`
2. `~/.codex/skills-mirror` (a mirror of Claude skills)
3. `~/.claude/skills`
4. `~/.agent/skills`

You can customize the default discovery priority, along with `expose_agents` and `cache_ttl_ms` settings, by creating a [`~/.codex/skills-manifest.json`](~/.codex/skills-manifest.json) file. This manifest supports a structured object format:

```json
{ "priority": ["codex","mirror","claude","agent"], "expose_agents": true, "cache_ttl_ms": 60000 }
```

Alternatively, a legacy shorthand format is also supported, with only the priority array:

```json
["agent","codex","mirror","claude"]
```

## Autoload Filtering

Upon the submission of a user prompt, `skrills` filters skills to select only the most relevant ones.

1. **Hook Timing (Claude)**: Autoloading is triggered via the `UserPromptSubmit` hook, which is natively supported by Claude Code.
2. **MCP Path (Codex)**: Codex does not use the Claude hook. It discovers the `skrills` MCP server from `~/.codex/AGENTS.md` (generated by `skrills sync` or the installer) and calls the `autoload-snippet` tool over stdio. Ensure `AGENTS.md` contains the `available_agents` entry for `skrills` with `command: skrills` and `args: ["serve"]`.
2. **Intent Parsing**: `skrills` analyzes the submitted prompt to understand the user's intent.
3. **Cached Query**: The system then queries a pre-indexed, cached skill index to identify matching skills.
4. **Context Injection**: Only the skills identified as relevant are injected into the context window provided to the LLM.

This optimized process avoids the need to load all available skills or perform disk reads for every prompt, significantly improving performance.

### Practical Flows

**Using the CLI for Testing:**

```bash
skrills render-preview --prompt "write a rust http server" \
  --max-bytes 12000 --diagnose
# Outputs matched skills + byte estimate, no content

skrills emit-autoload --prompt "write a rust http server" \
  --max-bytes 12000 --include-claude
# Returns manifest-first payload plus content; hook uses the same path on submit
```

Key inputs include `prompt`, `embed_threshold`, `include_claude`, `max_bytes`, `auto_pin`, and `diagnose`. If `embed_threshold` is not provided, the system uses the value from `SKRILLS_EMBED_THRESHOLD` (defaulting to `0.3`).

**Codex setup quick check (MCP path):**

```bash
skrills sync            # regenerates ~/.codex/AGENTS.md with the skrills MCP entry
cat ~/.codex/AGENTS.md  # verify an available_agents block with command: skrills, args: ["serve"]
skrills render-preview --prompt "list subagent tools"  # dry-run what Codex will inject
```

### Preseeding Pins at Startup

To always load specific skills without the overhead of re-reading them from disk, configure the `SKRILLS_PINNED` environment variable as follows:

```bash
export SKRILLS_PINNED="skill-a,skill-b"
```

These values are merged with the stored pinned set located at [`~/.codex/skills-pinned.json`](~/.codex/skills-pinned.json) during system startup. To stop auto-pinning these entries, simply remove the corresponding environment variable.

## Caching

`skrills` uses a two-tiered caching strategy to improve performance:

- **Discovery Cache**: This cache stores discovered skills and is configured with a Time-To-Live (TTL) using either `SKRILLS_CACHE_TTL_MS` or the `cache_ttl_ms` parameter in the manifest. It can be invalidated automatically by a file watcher (enabled by the `--watch` flag) or explicitly through the `refresh-cache` command.
- **Content Cache**: This cache stores the actual skill content, uniquely identified by its file path and content hash. It automatically refreshes when file changes are detected or a hash mismatch occurs.

## Comparison with Other Loaders

`skrills`'s autoloading mechanism is different from other skill loaders in several key ways:

- **Dynamic Loading**: Unlike methods that preload all skills, `skrills` uses a prompt hook to parse user intent and dynamically load only the skills relevant to the current context.
- **Local Caching**: Skills are cached locally, which significantly reduces network requests or repeated tool calls for `SKRILL.md` files on each interaction, which improves overall performance.
